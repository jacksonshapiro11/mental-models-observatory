name: Test Secret Update

on:
  workflow_dispatch: # Manual trigger only

permissions:
  secrets: write   # Allow updating secrets

jobs:
  test-pat:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test PAT access
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_PAT || secrets.PAT }}
        run: |
          echo "ğŸ§ª Testing PAT access..."
          
          if [ -z "$GITHUB_PAT" ]; then
            echo "âŒ No PAT found (checked GITHUB_PAT and PAT secrets)"
            echo "ğŸ’¡ Make sure you've added a PAT secret named 'PAT' or 'GITHUB_PAT'"
            exit 1
          fi
          
          echo "âœ… PAT found (length: ${#GITHUB_PAT} chars)"
          
          # Test gh CLI authentication
          echo "ğŸ” Testing GitHub CLI authentication..."
          export GH_TOKEN="$GITHUB_PAT"
          
          # Try to get repo info (read-only test)
          if gh repo view --json name > /dev/null 2>&1; then
            echo "âœ… GitHub CLI authentication successful!"
            echo "âœ… PAT has read access"
          else
            echo "âŒ GitHub CLI authentication failed"
            echo "ğŸ’¡ Check that your PAT has 'repo' scope"
            exit 1
          fi
          
          # Test secret update capability (dry run - just check permissions)
          echo "ğŸ” Testing secret update permissions..."
          if gh secret list > /dev/null 2>&1; then
            echo "âœ… PAT has secret read access"
            echo "âœ… Secret update should work!"
          else
            echo "âš ï¸  Cannot read secrets (may need 'repo' scope)"
            echo "ğŸ’¡ Your PAT might not have permission to update secrets"
          fi
          
          echo ""
          echo "âœ… All tests passed! Your PAT is configured correctly."
          echo "ğŸ’¡ The automatic secret update will work when refresh tokens rotate."


